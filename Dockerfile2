FROM golang:1.25-alpine AS builder
WORKDIR /app

ARG DERP_VERSION=latest
# 设置环境变量进行静态编译
ENV CGO_ENABLED=0
ENV GOOS=linux
# RUN go install -ldflags="-s -w" tailscale.com/cmd/derper@${DERP_VERSION}
RUN apk update && apk add --no-cache git && git clone --depth 1  https://github.com/tailscale/tailscale.git .
# --- 核心修改：注释掉 cert.go 中的主机名校验 ---
# 定位到 manualCertManager.getCertificate 方法，注释掉 if 块
RUN sed -i \
    '/if hi.ServerName != m.hostname && !m.noHostname {/,/}/ s/^/\/\//' \
    cmd/derper/cert.go
# 编译 derper（静态链接，适用于 alpine 镜像）
WORKDIR /app/cmd/derper
RUN go build -ldflags="-s -w" -o /app/derper .


FROM golang:1.25-alpine AS build-env

WORKDIR /go/src/tailscale

COPY go.mod go.sum ./
RUN go mod download

# Pre-build some stuff before the following COPY line invalidates the Docker cache.
RUN go install \
    github.com/aws/aws-sdk-go-v2/aws \
    github.com/aws/aws-sdk-go-v2/config \
    gvisor.dev/gvisor/pkg/tcpip/adapters/gonet \
    gvisor.dev/gvisor/pkg/tcpip/stack \
    golang.org/x/crypto/ssh \
    golang.org/x/crypto/acme \
    github.com/coder/websocket \
    github.com/mdlayher/netlink

COPY . .

# see build_docker.sh
ARG VERSION_LONG=""
ENV VERSION_LONG=$VERSION_LONG
ARG VERSION_SHORT=""
ENV VERSION_SHORT=$VERSION_SHORT
ARG VERSION_GIT_HASH=""
ENV VERSION_GIT_HASH=$VERSION_GIT_HASH
ARG TARGETARCH

RUN GOARCH=$TARGETARCH go install -ldflags="\
      -X tailscale.com/version.longStamp=$VERSION_LONG \
      -X tailscale.com/version.shortStamp=$VERSION_SHORT \
      -X tailscale.com/version.gitCommitStamp=$VERSION_GIT_HASH" \
      -v ./cmd/tailscale ./cmd/tailscaled ./cmd/containerboot

FROM alpine:3.22
RUN apk add --no-cache ca-certificates iptables iproute2 ip6tables
# Alpine 3.19 replaced legacy iptables with nftables based implementation.
# Tailscale is used on some hosts that don't support nftables, such as Synology
# NAS, so link iptables back to legacy version. Hosts that don't require legacy
# iptables should be able to use Tailscale in nftables mode.  See
# https://github.com/tailscale/tailscale/issues/17854
RUN rm /usr/sbin/iptables && ln -s /usr/sbin/iptables-legacy /usr/sbin/iptables
RUN rm /usr/sbin/ip6tables && ln -s /usr/sbin/ip6tables-legacy /usr/sbin/ip6tables

COPY --from=build-env /go/bin/* /usr/local/bin/
# For compat with the previous run.sh, although ideally you should be
# using build_docker.sh which sets an entrypoint for the image.
RUN mkdir /tailscale && ln -s /usr/local/bin/containerboot /tailscale/run.sh


RUN apk update \
    && apk add --no-cache ca-certificates curl nftables python3 bash tzdata py3-netifaces py3-yaml py3-schedule
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && rm -rf /var/cache/apk/*

# COPY --from=builder /go/bin/derper /opt/
COPY --from=builder /app/derper /opt/
